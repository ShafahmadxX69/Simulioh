<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Container Visualizer – Perfect Packing</title>
  <style>
    body{margin:0;overflow:hidden;font-family:system-ui}
    canvas{display:block}
    #reportContainer{position:absolute;left:0;right:0;bottom:0;
      background:rgba(255,255,255,0.96);border-top:2px solid #000;
      font-family:monospace;font-size:12px;max-height:35%;overflow:auto;
      padding:8px;white-space:pre}
  </style>
</head>
<body>
  <canvas id="threeCanvas"></canvas>
  <div id="reportContainer"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
  const VISUAL_GAP = 2;

  const containerSizeMap = {
    "20FT (GP)": { length: 5898, width: 2352, height: 2393 },
    "40FT (GP)": { length: 12032, width: 2352, height: 2393 },
    "40FT (HQ)": { length: 12032, width: 2352, height: 2698 }
  };

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xffffff);
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 100000);
  camera.position.set(9000, 6000, 9000);

  const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector('#threeCanvas'), antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff,0.9));
  const dir = new THREE.DirectionalLight(0xffffff,0.6); dir.position.set(1,2,1); scene.add(dir);

  const mainGroup = new THREE.Group(); scene.add(mainGroup);

  function withOutline(mesh){
    const edges = new THREE.EdgesGeometry(mesh.geometry);
    const line  = new THREE.LineSegments(edges,new THREE.LineBasicMaterial({color:0x000}));
    mesh.add(line); return mesh;
  }

  function addBox(dim,pos,color,xOffset){
    const geometry = new THREE.BoxGeometry(
      dim.l-VISUAL_GAP, dim.h-VISUAL_GAP, dim.w-VISUAL_GAP
    );
    const material = new THREE.MeshStandardMaterial({ color:new THREE.Color(color), opacity:0.97 });
    const box = new THREE.Mesh(geometry,material);
    box.position.set(pos.x+dim.l/2+xOffset,pos.y+dim.h/2,pos.z+dim.w/2);
    withOutline(box);
    mainGroup.add(box);
  }

  function getAllRotations(dim){
    const {length:L,width:W,height:H} = dim;
    return [
      {l:L,w:W,h:H},{l:L,w:H,h:W},
      {l:W,w:L,h:H},{l:W,w:H,h:L},
      {l:H,w:L,h:W},{l:H,w:W,h:L}
    ];
  }

  function packContainer(container,index){
    const size = containerSizeMap[container.type];
    const xOffset = index===0?0:index* (size.length+500);

    // wireframe kontainer
    const wireGeo = new THREE.BoxGeometry(size.length,size.height,size.width);
    const wire = new THREE.LineSegments(new THREE.EdgesGeometry(wireGeo),new THREE.LineBasicMaterial({color:0x000000}));
    wire.position.set(xOffset+size.length/2,size.height/2,size.width/2);
    mainGroup.add(wire);

    // expand semua items → jadi satu list box
    let jobs = [];
    for(const it of container.items){
      const rots = getAllRotations(it.dimensions);
      // ambil rotasi dengan volume optimal (supaya efisien)
      let best = rots[0];
      for(const r of rots){ if(r.l*r.w*r.h < best.l*best.w*best.h) best=r; }
      for(let i=0;i<it.qty;i++) jobs.push({...it, dims:best});
    }
    // urutkan volume besar → kecil
    jobs.sort((a,b)=>(b.dims.l*b.dims.w*b.dims.h)-(a.dims.l*a.dims.w*a.dims.h));

    let posX=0,posY=0,posZ=0,rowHeight=0,lineDepth=0;
    let report = [];

    for(const job of jobs){
      const {l,w,h} = job.dims;
      // kalau overflow lebar → geser Z
      if(posZ+w>size.width){
        posZ=0; posX+=lineDepth; lineDepth=0;
      }
      // kalau overflow panjang → naik Y
      if(posX+l>size.length){
        posX=0; posZ=0; posY+=rowHeight; rowHeight=0;
      }
      if(posY+h>size.height) {
        report.push(`Gagal place ${job.model}`); continue;
      }

      addBox(job.dims,{x:posX,y:posY,z:posZ},job.color||'#888',xOffset);
      posZ+=w; 
      lineDepth=Math.max(lineDepth,l);
      rowHeight=Math.max(rowHeight,h);
      report.push(`Placed ${job.model} at (${posX},${posY},${posZ})`);
    }
    return report.join("\n");
  }

  function renderContainers(payload){
    mainGroup.clear();
    let reports=[];
    payload.forEach((c,i)=>{reports.push(packContainer(c,i));});
    document.getElementById("reportContainer").textContent=reports.join("\n\n");
  }

  // listener pesan eksternal
  window.addEventListener("message",(ev)=>{
    if(ev.data?.type==="RENDER_CONTAINER"){
      renderContainers(ev.data.payload);
    }
  });

  function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera);}
  animate();
  </script>
</body>
</html>
