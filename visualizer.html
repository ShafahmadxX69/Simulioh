<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Container Visualizer – Perfect Packing</title>
  <style>
    :root{
      --panel-bg:#f7f7f8; --border:#d8d8de;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{box-sizing:border-box}
    body{margin:0;overflow:hidden;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    canvas{display:block}
    #sidebar{position:absolute;inset:0 auto 0 0;width:280px;background:var(--panel-bg);border-right:1px solid var(--border);z-index:10;padding:12px;overflow:auto}
    #sidebar h3{margin:0 0 8px}
    .containerBox{background:#fff;border:1px solid var(--border);border-radius:10px;padding:10px;margin-bottom:10px}
    .muted{color:#666;font-size:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .tag{border:1px solid var(--border);border-radius:999px;padding:2px 8px;font-size:12px;background:#fff}
    #reportContainer{position:absolute;left:280px;right:0;bottom:0;background:rgba(255,255,255,0.96);border-top:2px solid #000;z-index:5;font-family:var(--mono);font-size:12px;max-height:35%;overflow:auto;display:flex;flex-wrap:wrap;gap:8px;padding:8px}
    .reportBox{border:1px solid var(--border);background:#fff;border-radius:8px;padding:10px;white-space:pre-wrap;flex:1 1 280px}
    #topbar{position:absolute;left:280px;right:0;top:0;height:46px;background:rgba(255,255,255,0.9);border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;padding:0 10px;z-index:8;backdrop-filter:blur(4px)}
    #topbar button,#topbar select{border:1px solid var(--border);background:#fff;padding:6px 10px;border-radius:8px;cursor:pointer;font-size:13px}
    #topbar .spacer{flex:1}
    #legend{font-family:var(--mono);font-size:11px;color:#444}
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Container List</h3>
    <div id="containerList"></div>
    <div id="legend" class="muted">
      <p><strong>Legend:</strong></p>
      <p>- X: depan → belakang (panjang)<br>
         - Y: lantai → atas (tinggi)<br>
         - Z: kiri → kanan (lebar)</p>
      <p>- GAP visual: 2 mm</p>
    </div>
  </div>

  <div id="topbar">
    <button id="btnClearCache" title="Hapus cache lokal">Clear Cache</button>
    <label class="muted">Mode: Auto Packing</label>
    <div class="spacer"></div>
    <span class="muted">Tip: kirim payload via <code>postMessage</code> → { type:"RENDER_CONTAINER", payload }</span>
  </div>

  <div id="reportContainer"></div>
  <canvas id="threeCanvas"></canvas>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
  <script>
  const LOGIC_GAP = 0;
  const VISUAL_GAP = 2;

  const containerSizeMap = {
    "20FT (GP)": { length: 5898, width: 2352, height: 2393 },
    "40FT (GP)": { length: 12032, width: 2352, height: 2393 },
    "40FT (HQ)": { length: 12032, width: 2352, height: 2698 }
  };

  const scene = new THREE.Scene();
  scene.background = new THREE.Color(0xffffff);
  const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 1, 100000);
  camera.position.set(9000, 6000, 9000);

  const renderer = new THREE.WebGLRenderer({ canvas: document.querySelector('#threeCanvas'), antialias: true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.setSize(window.innerWidth, window.innerHeight);

  const controls = new THREE.OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true; controls.dampingFactor = 0.08;

  const ambient = new THREE.AmbientLight(0xffffff, 0.9); scene.add(ambient);
  const dir = new THREE.DirectionalLight(0xffffff, 0.6); dir.position.set(1,2,1); scene.add(dir);

  const mainGroup = new THREE.Group(); scene.add(mainGroup);
  let containerOffsets = [], data = [];

  function clearScene(){ mainGroup.clear(); }

  function withOutline(mesh, color = 0x000000){
    const edges = new THREE.EdgesGeometry(mesh.geometry);
    const line  = new THREE.LineSegments(edges, new THREE.LineBasicMaterial({ color }));
    mesh.add(line); return mesh;
  }

  function addBox(dim, pos, color, xOffset){
    const geometry = new THREE.BoxGeometry(
      Math.max(1, dim.l - VISUAL_GAP),
      Math.max(1, dim.h - VISUAL_GAP),
      Math.max(1, dim.w - VISUAL_GAP)
    );
    const material = new THREE.MeshStandardMaterial({ color: new THREE.Color(color), transparent:false, opacity:0.97 });
    const box = new THREE.Mesh(geometry, material);
    box.position.set(pos.x + dim.l/2 + xOffset, pos.y + dim.h/2, pos.z + dim.w/2);
    withOutline(box, 0x111111);
    mainGroup.add(box);
  }

  function getAllRotations(dim){
    const L = dim.length ?? dim.l, W = dim.width ?? dim.w, H = dim.height ?? dim.h;
    const perms = [
      {l:L,w:W,h:H},{l:L,w:H,h:W},
      {l:W,w:L,h:H},{l:W,w:H,h:L},
      {l:H,w:L,h:W},{l:H,w:W,h:L}
    ];
    const uniq = new Set(); const out=[];
    for(const p of perms){ const k=`${p.l}|${p.w}|${p.h}`; if(!uniq.has(k)){ uniq.add(k); out.push(p); } }
    out.sort((a,b)=> (a.h-b.h) || ((b.l*b.w)-(a.l*a.w)) );
    return out;
  }

  // ✅ Smart packing dengan rotasi + tangga
  function packContainer(container){
    const size = containerSizeMap[container.type];
    const xOffset = container.index===0 ? 0
      : containerOffsets[container.index-1] + containerSizeMap[data[container.index-1].type].length + 500;
    containerOffsets[container.index] = xOffset + size.length;

    // wireframe container
    const wireGeo = new THREE.BoxGeometry(size.length, size.height, size.width);
    const wire = new THREE.LineSegments(new THREE.EdgesGeometry(wireGeo), new THREE.LineBasicMaterial({color:0x000000}));
    wire.position.set(xOffset + size.length/2, size.height/2, size.width/2);
    mainGroup.add(wire);

    // urutkan item by volume (besar dulu)
    const items = container.items.map(it=>({
      ...it,
      dims: { l: it.dimensions.length, w: it.dimensions.width, h: it.dimensions.height },
      qty: parseInt(it.qty) || 0
    })).filter(it=>it.qty>0)
      .sort((a,b)=> (b.dims.l*b.dims.w*b.dims.h) - (a.dims.l*a.dims.w*a.dims.h));

    const report = [];
    for(const it of items){
      let remaining = it.qty, placed=0;
      const rots = getAllRotations(it.dims);

      let posX=0,posY=0,posZ=0,maxRowH=0;

      while(remaining>0){
        let fit=null;
        for(const r of rots){
          if(posX+r.l<=size.length && posY+r.h<=size.height && posZ+r.w<=size.width){ fit=r; break; }
        }
        if(!fit){
          // geser ke belakang (Z)
          posZ+=maxRowH; 
          if(posZ>=size.width){
            posZ=0; posX+=it.dims.l; maxRowH=0;
          }
          if(posX>=size.length){ posX=0; posY+=it.dims.h; }
          if(posY>=size.height) break;
          continue;
        }

        addBox(fit, {x:posX,y:posY,z:posZ}, it.color||'#888', xOffset);
        placed++; remaining--;

        posX+=fit.l;
        maxRowH=Math.max(maxRowH,fit.w);
        if(posX+fit.l>size.length){
          posX=0; posZ+=maxRowH;
          maxRowH=0;
        }
        if(posZ+fit.w>size.width){
          posZ=0; posY+=fit.h;
        }
      }

      report.push(`${container.label} — ${it.model} ${it.size} → Placed: ${placed} | Missed: ${Math.max(0,it.qty-placed)}`);
    }

    return report.join('\n');
  }

  function renderContainers(payload){
    clearScene(); containerOffsets = []; data = payload.map((c,i)=>({...c, index:i, label:`C${i+1}`})); 
    const reports=[]; for(const c of data){ reports.push(packContainer(c)); }
    showReport(reports.join('\n\n'));
  }

  function showReport(text){
    const el=document.getElementById('reportContainer');
    el.innerHTML='';
    const box=document.createElement('div');
    box.className='reportBox';
    box.textContent=text||'—';
    el.appendChild(box);
  }

  window.addEventListener('message',(event)=>{
    if(event?.data?.type==='RENDER_CONTAINER'){
      try{ renderContainers(event.data.payload); }
      catch(e){ console.error(e); showReport('Error: '+e.message); }
    }
  });

  document.getElementById('btnClearCache').addEventListener('click',()=>{ localStorage.clear(); alert('Cache cleared'); });

  function onResize(){
    const w=window.innerWidth,h=window.innerHeight;
    renderer.setSize(w,h); camera.aspect=w/h; camera.updateProjectionMatrix();
  }
  window.addEventListener('resize',onResize);

  function animate(){ requestAnimationFrame(animate); controls.update(); renderer.render(scene,camera); }
  animate();
  </script>
</body>
</html>
